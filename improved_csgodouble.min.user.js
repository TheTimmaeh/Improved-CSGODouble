// ==UserScript==
// @name         Improved CSGODouble.com
// @namespace    http://timmaeh.de/csgodouble/
// @version      0.9h
// @description  Improves your experience on CSGODouble.com
// @author       Timmaeh - http://timmaeh.de
// @match        http://www.csgodouble.com/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @updateURL    http://timmaeh.de/csgodouble/improved_csgodouble.min.user.js
// @downloadURL  http://timmaeh.de/csgodouble/improved_csgodouble.min.user.js
// ==/UserScript==

$(document).ready(function(){$("head").append('<script type="text/javascript" src="https://rawgit.com/inuyaksa/jquery.nicescroll/master/jquery.nicescroll.min.js"></script>');var t=setInterval(function(){"function"==typeof $("#chatArea").niceScroll&&($("#chatArea").addClass("IMP_scroll").niceScroll({cursorcolor:"#888",cursorborder:"1px solid #888",cursoropacitymin:0,cursoropacitymax:.6,autohidemode:"cursor",hidecursordelay:250,railpadding:{top:3,right:3,bottom:3,left:0}}),$("#chatForm .checkbox.pull-right").removeClass("checkbox").html('<a href="#" data-toggle="modal" data-target="#chatRules">Chat Rules</a>'),$($("#chatForm .pull-left")[1]).remove(),clearInterval(t))},100)});var IMP={last_roll_id:0,last_roll_color:0,last_roll_color_count:0,settings:{sound:!1,mute_mute:!1,spambot:!1,spoil_roll:!1,show_rolls:!1,hide_bet_confirm:!1,show_mod_tools:!1,filter_usernames:!1,console_log:!1,autoreconnect:!1},stats:{won:[[0,0],[0,0],[0,0]],lost:[[0,0],[0,0],[0,0]]},mod_html:'<div id="IMP_mod_tools" style="display:none;margin:20px 5px 5px;"><div class="form-group"><div class="btn-group"><button type="button" class="btn btn-default modshort" data-seconds="1" disabled>Unmute</button><button type="button" class="btn btn-default modshort" data-seconds="60" disabled>Mute 60s</button><button type="button" class="btn btn-default modshort" data-seconds="1800" disabled>30m</button><button type="button" class="btn btn-default modshort" data-seconds="3600" disabled>1h</button><button type="button" class="btn btn-default modshort" data-seconds="21600" disabled>6h</button><button type="button" class="btn btn-default modshort" data-seconds="86400" disabled>24h</button></div></div>',calc_html:'<div style="margin:10px;"><div style="font-size:16px;font-weight:bold;margin-bottom:8px;">Betting Calculator</div></div>',log_html:'<div style="margin:10px;"><div style="font-size:16px;font-weight:bold;margin-bottom:8px;">Bet History <span style="font-size:10px;font-weight:normal;font-style:italic;">for the current session</span></div><table border="1" style="width:100%;border-color:#F5F5F5;"><thead><tr><th style="text-align:center;">Roll ID</th><th style="text-align:center;">Amount</th><th style="text-align:center;">Target</th><th style="text-align:center;">Roll</th><th style="text-align:center;">Profit</th></tr></thead><tbody></tbody></table></div>',stats_html:'<div style="margin:10px;"><div style="font-size:16px;font-weight:bold;margin-bottom:8px;">Bet Statistics <span style="font-size:10px;font-weight:normal;font-style:italic;">for the current session</span></div>Your Winnings<table id="IMP_log_winnings" style="width:100%"><tr><td colspan="3" style="padding:5px;background-color:#F5F5F5;font-size:16px;font-weight:bold;text-align:center;">+1000</td></tr><tr><td class="red" style="padding:5px;background-color:#c9302c;color:#FFF;font-size:13px;font-weight:bold;text-align:center;">+200</td><td class="green" style="padding:5px;background-color:#449d44;color:#FFF;font-size:13px;font-weight:bold;text-align:center;">+300</td><td class="black" style="padding:5px;background-color:#444;color:#FFF;font-size:13px;font-weight:bold;text-align:center;">+500</td></tr></table>Your Losses<table id="IMP_log_winnings" style="width:100%"><tr><td colspan="3" style="padding:5px;background-color:#F5F5F5;font-size:16px;font-weight:bold;text-align:center;">+1000</td></tr><tr><td class="red" style="padding:5px;background-color:#c9302c;color:#FFF;font-size:13px;font-weight:bold;text-align:center;">+200</td><td class="green" style="padding:5px;background-color:#449d44;color:#FFF;font-size:13px;font-weight:bold;text-align:center;">+300</td><td class="black" style="padding:5px;background-color:#444;color:#FFF;font-size:13px;font-weight:bold;text-align:center;">+500</td></tr></table></div>',settings_html:'<div style="margin:10px;"><div style="font-size:16px;font-weight:bold;margin-bottom:8px;">Improved CSGODouble.com v0.9h<span style="font-size:10px;font-weight:normal;font-style:italic;">by Timmaeh</span></div><div class="IMP_setting" id="IMP_dark_theme" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Use Dark Theme</div><div class="IMP_setting" id="IMP_hide_footer" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Hide Footer</div><div class="IMP_setting" id="IMP_sound" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Play Sound on Roll</div><div class="IMP_setting" id="IMP_spoil_roll" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Spoil Roll in Bet History</div><div class="IMP_setting" id="IMP_show_rolls" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Show Rolls without Bets in Bet History</div><div class="IMP_setting" id="IMP_hide_bet_confirm" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Hide Bet Confirmations in Chat</div><div class="IMP_setting" id="IMP_filter_usernames" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Filter Usernames</div><div class="IMP_setting" id="IMP_console_log" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Enable Console Output</div><div class="IMP_setting" id="IMP_autoreconnect" style="cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Autoreconnect</div><div class="IMP_setting" id="IMP_show_mod_tools" style="display:none;cursor:pointer;margin:3px;"><i class="fa fa-times" style="width:18px;"></i> Show Mod Tools</div><audio id="IMP_roll" preload="auto"><source src="http://timmaeh.de/csgodouble/roll.mp3"></audio></div>',dark_html:"<style>body.dark_theme{background-color:#222;color:#EEE}.dark_theme nav{background-color:#333;border-color:#181818;color:#EEE}.dark_theme .navbar-default .navbar-brand{color:#EEE}.dark_theme .navbar-default .navbar-brand:hover{color:#AAA}.dark_theme .navbar-default .navbar-nav>li>a{color:#EEE}.dark_theme .navbar-default .navbar-nav>li>a:focus,.dark_theme .navbar-default .navbar-nav>li>a:hover{color:#AAA}.dark_theme .navbar-default .navbar-nav>.open>a,.dark_theme .navbar-default .navbar-nav>.open>a:focus,.dark_theme .navbar-default .navbar-nav>.open>a:hover{background-color:#555;color:#FFF}.dark_theme .navbar-nav>li>.dropdown-menu{background-color:#555}.dark_theme .dropdown-menu>li>a{color:#FFF}.dark_theme .dropdown-menu>li>a:focus,.dark_theme .dropdown-menu>li>a:hover{color:#222}.dark_theme #sidebar{background-color:#333;border-color:#181818;color:#EEE}.dark_theme .side-icon.active,.dark_theme .side-icon:hover{background-color:#555}.dark_theme #pullout{background-color:#333;border-color:#181818;color:#FFF}.dark_theme #tab1{height:auto!important}.dark_theme #tab1>div:first-child{margin:0!important;padding:5px;border-bottom:1px solid #181818}.dark_theme .divchat{padding:0;background-color:transparent;border-color:#181818}.dark_theme #lang{background-color:#222;border-color:#222;color:#FFF;text-transform:uppercase;font-weight:700}.dark_theme #lang:focus{outline:0;box-shadow:none}.dark_theme #chatArea>div:nth-child(even),.dark_theme #chatArea>div:nth-child(odd){box-shadow:rgba(255,255,255,.0392157) 0 1px 0 0 inset;border-bottom:1px solid #000}.dark_theme #chatArea>div{padding:5px}.dark_theme #chatArea>div:nth-child(odd){background-color:#333}.dark_theme #chatArea>div:nth-child(even){background-color:#2B2B2B}.dark_theme #chatForm .pull-left strong{font-weight:400;font-size:85%;color:#BBB}.dark_theme #chatForm div a{font-weight:400;color:#FFF}.dark_theme #chatMessage{background-color:#222;border-color:#111;color:#FFF}.dark_theme .chat-link,.dark_theme .chat-link:active,.dark_theme .chat-link:hover{color:#FFF}.dark_theme #contextMenu{background-color:#555;border-color:#333}.dark_theme #mainpage>div{background-color:#333;border-color:#000;color:#FFF}.dark_theme #mainpage>div.row{background-color:#222}.dark_theme .panel-default{background-color:#333;border-color:#000}.dark_theme .panel-default>.panel-heading{background-color:#444;border-color:#444}.dark_theme .my-row{border-color:#444}.dark_theme .betlist .list-group-item{background-color:#333;border-color:#444}.dark_theme footer{background-color:#2D2C2A;border-color:#222;color:#EEE}.dark_theme footer a,.dark_theme footer a:active,.dark_theme footer a:hover{color:#EEE}.dark_theme .modal-content{background-color:#333;color:#FFF}.dark_theme .modal-content>div{border-color:#222}.dark_theme .close{color:#FFF;opacity:.6}.dark_theme .close:focus,.dark_theme .close:hover{opacity:.8}</style>",init:function(){var t=$("#sidebar > div")[0],e=$(t).find("div")[0];$(e).clone().attr("id","IMP_log").attr("data-tab","12").removeClass("active").appendTo(t),$("#IMP_log").find(".fa").toggleClass("fa-commenting fa-list"),$("#IMP_log").find("span").attr("id","IMP_bet_count"),$("#pullout").append('<div id="tab12" class="tab-group hidden">'+IMP.log_html+"</div>"),$(e).clone().attr("id","IMP_settings").attr("data-tab","14").removeClass("active").appendTo(t),$("#IMP_settings").find(".fa").toggleClass("fa-commenting fa-cog"),$("#IMP_settings").find("span").remove(),$("#pullout").append('<div id="tab14" class="tab-group hidden">'+IMP.settings_html+"</div>"),$("head").append(IMP.dark_html),IMP.enable_sidebar_icons(),IMP.load_settings(),IMP.enable_settings()},enable_sidebar_icons:function(){$(".side-icon").off("click").on("click",function(t){t.preventDefault();var e=$(this).data("tab");return $(this).hasClass("active")?($(".side-icon").removeClass("active"),$(".tab-group").addClass("hidden"),$("#mainpage").css("margin-left","50px"),$("#pullout").addClass("hidden")):($(".side-icon").removeClass("active"),$(".tab-group").addClass("hidden"),$(this).addClass("active"),$("#tab"+e).removeClass("hidden"),$("#mainpage").css("margin-left","450px"),$("#pullout").removeClass("hidden"),1==e&&$("#newMsg").html("")),snapRender(),!1})},enable_settings:function(){$(".IMP_setting").off("click").on("click",function(t){t.preventDefault(),$(this).find("i.fa").toggleClass("fa-check fa-times"),IMP.settings[$(this).attr("id").substr(4)]=$(this).find("i.fa").hasClass("fa-check")?!0:!1,IMP.save_settings(),"show_rolls"==$(this).attr("id").substr(4)?IMP.settings.show_rolls?$(".IMP_show_rolls_roll").show():$(".IMP_show_rolls_roll").hide():"dark_theme"==$(this).attr("id").substr(4)?IMP.settings.dark_theme?$("body").addClass("dark_theme"):$("body").removeClass("dark_theme"):"hide_footer"==$(this).attr("id").substr(4)?IMP.settings.hide_footer?$("footer").hide():$("footer").show():"show_mod_tools"==$(this).attr("id").substr(4)&&(IMP.settings.show_mod_tools?($("#IMP_mod_tools").show(),IMP.enable_mod_tools()):($("#IMP_mod_tools").hide(),$(window).off("click"),$(".modshort").off("click")))}),IMP.settings.dark_theme?$("body").addClass("dark_theme"):$("body").removeClass("dark_theme"),IMP.settings.hide_footer?$("footer").hide():$("footer").show()},enable_mod_tools:function(){$(window).on("click",function(t){var e=$(t.target).closest("#chatArea > div")[0]||!1;$(t.target).hasClass("modshort")||($(".IMP_active_msg").removeClass("IMP_active_msg").css({border:"0px solid orange",borderBottom:"1px solid #000",padding:"5px"}),$(".modshort").prop("disabled",!0)),e&&$(e).find(".chat-img").length&&($(e).addClass("IMP_active_msg").css({border:"1px solid orange",padding:"4px 4px 5px 4px"}),$(".modshort").prop("disabled",!1))}),$(".modshort").off("click").on("click",function(t){console.log(t);var e=$(".IMP_active_msg > .chat-img").data("steamid"),o=$(this).data("seconds");send({type:"chat",msg:"/mute "+e+" "+o,lang:LANG})})},load_settings:function(){$.extend(IMP.settings,JSON.parse(GM_getValue("settings","{}"))),$.each(IMP.settings,function(t,e){e===!0?$("#IMP_"+t).find("i.fa").addClass("fa-check").removeClass("fa-times"):e===!1&&$("#IMP_"+t).find("i.fa").addClass("fa-times").removeClass("fa-check")})},save_settings:function(){GM_setValue("settings",JSON.stringify(IMP.settings))},log_bet:function(t,e,o,a){if($("#IMP_log_"+t+"_"+o+"_"+a).length)$("#IMP_log_"+t+"_"+o+"_"+a+" > .value").text(e);else{$("#tab12 tbody").prepend('<tr id="IMP_log_'+t+"_"+o+"_"+a+'"><td style="padding:3px 5px;text-align:right;font-weight:bold;">'+t+'</td><td class="value" style="padding:3px 8px;text-align:right;font-weight:bold;">'+e+'</td><td class="color" style="padding:3px 8px;color:#FFF;text-align:center;font-weight:bold;background-color:#'+(0==o?"449d44":8>o?"c9302c":"444")+';">'+(0==o?"0":o+" - "+a)+'</td><td class="result" style="padding:3px 8px;color:#FFF;text-align:center;font-weight:bold;"></td><td class="profit" style="padding:3px 8px;text-align:right;font-weight:bold;"></td></tr>');var l=parseInt($("#IMP_bet_count").html())||0;$("#IMP_bet_count").html(l+1)}},log_result:function(t,e){var o=0;$('tr[id^="IMP_log_'+t+'_"]').each(function(t,a){$(a).find(".result").css("background-color",0==e?"#449d44":8>e?"#c9302c":"#444").text(e);var l=$(a).find(".color").text(),r=parseInt($(a).find(".value").text());r="0"==l&&0==e?13*r:"1 - 7"==l&&e>0&&8>e?r:"8 - 14"==l&&e>7?r:-1*r,IMP.update_stats(l,r),$(a).find(".profit").css("color",r>0?"#3c763d":"#a94442").text(r>0?"+"+r:r),o++}),0==o&&($("#tab12 tbody").prepend('<tr id="IMP_log_'+t+'" class="IMP_show_rolls_roll" style="'+(IMP.settings.show_rolls?"":"display:none;")+'"><td style="padding:3px 5px;text-align:right;font-weight:bold;">'+t+'</td><td class="value" style="padding:3px 8px;text-align:right;font-weight:bold;"> - - - </td><td class="color" style="padding:3px 8px;text-align:center;font-weight:bold;"> - - - </td><td class="result" style="padding:3px 8px;color:#FFF;text-align:center;font-weight:bold;"></td><td class="profit" style="padding:3px 8px;text-align:right;font-weight:bold;"> - - - </td></tr>'),$("#IMP_log_"+t+" .result").css("background-color",0==e?"#449d44":8>e?"#c9302c":"#444").text(e)),IMP.settings.sound&&$("#IMP_roll")[0].play(),"function"==typeof IMP.log_result_callback&&IMP.log_result_callback.call()},update_stats:function(t,e){},filter_name:function(t){var e=t.replace(/((TWITCH((|\.|DOT)(TV))?\/?)|(CSGODOUBLE((|\.|DOT)(COM))?)|(\W(CS|SKIN|FREE)[\w-]+((|\.|DOT)(\w{2,6}))?)|FREE|500|COINS?|(REFER(AL)?)?CODE)/gi,""),o="",a="";return e.length<2?t:(t!=e&&(o=e.replace(/(^[\W_]+|[\W_]+$)/g,"")),o.length<2&&(o=e),a=o.replace(/[\W_]{3,}/g," "),a.length<2&&(a=o),t!=a&&IMP.settings.console_log&&console.log(t,">>>",a),a)},reconnecting:!1,reconnect:function(){IMP.reconnecting=!1,connect()},highlight:function(t){console.log(t)}};unsafeWindow.IMP=IMP,unsafeWindow.IMP.init(),unsafeWindow.addHist=function(t,e){var o=$("#past .ball").length;o>=10&&$("#past .ball").first().remove(),0==t?$("#past").append('<div data-rollid="'+e+'" class="ball ball-0">'+t+"</div>"):7>=t?$("#past").append('<div data-rollid="'+e+'" class="ball ball-1">'+t+"</div>"):$("#past").append('<div data-rollid="'+e+'" class="ball ball-8">'+t+"</div>"),t=0==t?0:8>t?1:8,IMP.last_roll_color==t?IMP.last_roll_color_count++:(IMP.last_roll_color=t,IMP.last_roll_color_count=1)},unsafeWindow.spin=function(t){var e=t.roll;play_sound("roll");for(var o=[1,14,2,13,3,12,4,0,11,5,10,6,9,7,8],a=0,l=0;l<o.length;l++)if(e==o[l]){a=l;break}var r=34,s=-34,n=Math.floor(t.wobble*(r-s+1)+s),i=75*a+36+n+5625;animStart=(new Date).getTime(),vi=getVi(i),tf=getTf(vi),isMoving=!0,IMP.settings.spoil_roll&&IMP.log_result(t.rollid,t.roll),setTimeout(function(){IMP.settings.spoil_roll||IMP.log_result(t.rollid,t.roll),finishRoll(t,tf)},tf),render()},unsafeWindow.onMessage=function(t){try{var e=JSON.parse(t.data);if("preroll"==e.type){$("#counter").finish(),$("#banner").html("Confirming "+e.totalbets+" total bets..."),$("#panel0-0 .total").countTo(e.sums[0]),$("#panel1-7 .total").countTo(e.sums[1]),$("#panel8-14 .total").countTo(e.sums[2]);try{tinysort("#panel1-7 .betlist>li",{data:"amount",order:"desc"})}catch(o){}try{tinysort("#panel8-14 .betlist>li",{data:"amount",order:"desc"})}catch(o){}try{tinysort("#panel0-0 .betlist>li",{data:"amount",order:"desc"})}catch(o){}}else if("roll"==e.type)$(".betButton").prop("disabled",!0),$("#counter").finish(),$("#banner").html("***ROLLING***"),ROUND=e.rollid,spin(e);else if("chat"==e.type)IMP.settings.filter_usernames&&(e.name=IMP.filter_name(e.name)),chat("player",e.msg,e.name,e.icon,e.user,e.rank,e.lang);else if("hello"==e.type){cd(e.count),USER=e.user,RANK=e.rank,RANK>0&&($("#IMP_show_mod_tools").show(),$("#tab1").append(IMP.mod_html),IMP.settings.show_mod_tools?($("#IMP_mod_tools").show(),IMP.enable_mod_tools()):($("#IMP_mod_tools").hide(),$(window).off("click"),$(".modshort").off("click"))),$("#balance").countTo(e.balance);for(var a=0,l=0;l<e.rolls.length;l++)addHist(e.rolls[l].roll,e.rolls[l].rollid),a=e.rolls[l].roll,ROUND=e.rolls[l].rollid;snapRender(a,e.last_wobble),MAX_BET=e.maxbet,chat("alert","## Min bet: "+e.minbet+" coin/s"),chat("alert","## Max bet: "+formatNum(MAX_BET)+" coins"),chat("alert","## Max bets per roll: "+e.br),chat("alert","## Roll countdown: "+e.accept+" sec"),chat("alert","## Chat: "+e.chat+" sec cooldown ("+e.chatb+"+ total bet)")}else"bet"==e.type?(IMP.settings.filter_usernames&&(e.bet.name=IMP.filter_name(e.bet.name)),addBet(e.bet),$("#panel0-0 .total").countTo(e.sums[0]),$("#panel1-7 .total").countTo(e.sums[1]),$("#panel8-14 .total").countTo(e.sums[2])):"betconfirm"==e.type?($("#panel"+e.bet.lower+"-"+e.bet.upper+" .mytotal").countTo(e.bet.amount),$("#balance").countTo(e.balance,{color:!0}),$(".betButton").prop("disabled",!1),IMP.settings.hide_bet_confirm||chat("alert","Bet #"+e.bet.betid+" confirmed "+e.mybr+"/"+e.br+" ("+e.exec/1e3+" sec) "),IMP.log_bet(ROUND+1,e.bet.amount,e.bet.lower,e.bet.upper)):"error"==e.type?(chat("error",e.error),e.enable&&$(".betButton").prop("disabled",!1)):"alert"==e.type?(chat("alert",e.alert),e.maxbet&&(MAX_BET=e.maxbet),isNaN(e.balance)||(console.log("setting balance = %s",e.balance),$("#balance").countTo(e.balance,{color:!0}))):"logins"==e.type?$("#isonline").html(e.count):"balance"==e.type&&$("#balance").fadeOut(100).html(e.balance).fadeIn(100)}catch(o){console.log("Error: "+t.data+" "+o)}},unsafeWindow.chat=function(t,e,o,a,l,r,s){if(s==LANG||"italic"==t||"error"==t||"alert"==t){document.getElementById("chatArea");e=e.replace(/(<|>)/g,""),e=emotes(e);var n="";if("italic"==t)("Connection closed."==e||"Error: Connected closed."==e||"Error: Failed to get AT"==e)&&(IMP.settings.autoreconnect&&!IMP.reconnecting?(e+=" Trying to reconnect.",IMP.reconnecting=!0,setTimeout(IMP.reconnect,3e3)):e+=' <a href="javascript:connect();">Try to reconnect.</a>'),n="<div><i>"+e+"</i></div>";else if("error"==t)n='<div><b class="text-danger">'+e+"</b></div>";else if("alert"==t)n='<div><b class="text-success">'+e+"</b></div>";else if("player"==t){var i="chat-link";100==r?(i="chat-link-mod",o="[Owner] "+o):1==r?(i="chat-link-pmod",o="[Mod] "+o):-1==r?(i="chat-link-streamer",o="[Streamer] "+o):-2==r&&(i="chat-link-ve",o="[Veteran] "+o),n='<div><img class="chat-img rounded" data-steamid="'+l+'" data-name="'+o+'" src="https://steamcdn-a.akamaihd.net/steamcommunity/public/images/avatars'+a+'"><a class="'+i+'" href="http://steamcommunity.com/profiles/'+l+'" target="_blank"><b>'+o+"</b></a>: "+e+"</div>"}var d=$CHATAREA[0].scrollHeight-499-$CHATAREA[0].scrollTop>100?!1:!0;if($CHATAREA.append(n),d&&$CHATAREA.hasClass("IMP_scroll")&&($CHATAREA.getNiceScroll().resize(),$CHATAREA.getNiceScroll(0).doScrollTop($CHATAREA[0].scrollHeight,100)),!$('.side-icon[data-tab="1"]').hasClass("active")){var c=parseInt($("#newMsg").html())||0;$("#newMsg").html(c+1)}}};
